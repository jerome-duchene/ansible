---
# tasks/system-cleanup.yml
- name: Calculer l'espace disque avant nettoyage
  shell: df -h / | awk 'NR==2 {print $5}' | sed 's/%//'
  register: disk_before
  changed_when: false
  
- name: Nettoyer le cache APT
  shell: |
    apt-get clean
    apt-get autoclean
  when: ansible_os_family == "Debian"
  
- name: Supprimer les paquets orphelins
  apt:
    autoremove: yes
    purge: yes
  when: ansible_os_family == "Debian"

- name: Nettoyer les vieux kernels (garder les 2 derniers)
  shell: |
    CURRENT_KERNEL=$(uname -r | sed 's/-generic//')
    dpkg -l 'linux-*' | awk '/^ii/ {print $2}' | \
    grep -E "linux-(image|headers|modules)-[0-9]" | \
    grep -v "$CURRENT_KERNEL" | \
    sort -V | head -n -2 | \
    xargs -r apt-get -y purge
  when: ansible_os_family == "Debian"
  ignore_errors: true
  
- name: Nettoyer les fichiers temporaires
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - /tmp/*
    - /var/tmp/*
  ignore_errors: true
  
- name: Calculer l'espace disque après nettoyage
  shell: df -h / | awk 'NR==2 {print $5}' | sed 's/%//'
  register: disk_after
  changed_when: false
  
- name: Afficher l'espace récupéré
  debug:
    msg: "Espace disque: {{ disk_before.stdout }}% → {{ disk_after.stdout }}%"
