---
- name: CVE Vulnerability Scanning with Trivy
  hosts: all
  become: yes
  vars:
    cve_report_dir: "/var/log/cve-scans"
    cve_report_file: "{{ cve_report_dir }}/cve-report-{{ ansible_hostname }}-{{ ansible_date_time.date }}.json"
    cve_summary_file: "{{ cve_report_dir }}/cve-summary-{{ ansible_hostname }}-{{ ansible_date_time.date }}.txt"
    gotify_url: "{{ vault_gotify_url | default('') }}"
    gotify_token: "{{ vault_gotify_token | default('') }}"
    # Mapping des distributions non supportÃ©es vers une version stable
    trivy_distro_map:
      trixie: bookworm
      sid: bookworm
      testing: bookworm

  tasks:
    - name: Create CVE report directory
      file:
        path: "{{ cve_report_dir }}"
        state: directory
        mode: '0755'

    - name: Check if Trivy is installed
      stat:
        path: /usr/bin/trivy
      register: trivy_installed

    - name: Set Trivy repository distribution
      set_fact:
        trivy_distro: "{{ trivy_distro_map[ansible_distribution_release] | default(ansible_distribution_release) }}"

    - name: Install Trivy (Debian/Ubuntu)
      block:
        - name: Ensure dependencies for GPG are installed
          apt:
            name:
              - ca-certificates
              - curl
              - gnupg
              - jq
            state: present
            update_cache: yes

        - name: Create keyrings directory
          file:
            path: /etc/apt/keyrings
            state: directory
            mode: '0755'

        - name: Download and add Trivy GPG key
          shell: |
            curl -fsSL https://aquasecurity.github.io/trivy-repo/deb/public.key | \
            gpg --dearmor -o /etc/apt/keyrings/trivy.gpg
          args:
            creates: /etc/apt/keyrings/trivy.gpg

        - name: Add Trivy repository
          apt_repository:
            repo: "deb [signed-by=/etc/apt/keyrings/trivy.gpg] https://aquasecurity.github.io/trivy-repo/deb {{ trivy_distro }} main"
            state: present
            filename: trivy

        - name: Install Trivy
          apt:
            name: trivy
            state: present
            update_cache: yes
      when:
        - not trivy_installed.stat.exists
        - ansible_os_family == "Debian"

    - name: Ensure jq is installed
      apt:
        name: jq
        state: present
      when: ansible_os_family == "Debian"

    - name: Update Trivy vulnerability database
      command: trivy image --download-db-only
      changed_when: false
      register: trivy_db_update
      retries: 3
      delay: 10
      until: trivy_db_update.rc == 0

    - name: Run Trivy CVE scan on system
      shell: |
        trivy rootfs --format json --severity CRITICAL,HIGH,MEDIUM,LOW \
          --output {{ cve_report_file }} / 2>&1 || true
        
        # CrÃ©er un rapport vide si le fichier n'existe pas
        if [ ! -f "{{ cve_report_file }}" ]; then
          echo '{"Results": []}' > {{ cve_report_file }}
          echo "Warning: Trivy scan produced no output, empty report created"
        fi
      args:
        executable: /bin/bash
      register: trivy_scan
      changed_when: false

    - name: Parse Trivy JSON report
      shell: |
        if [ ! -f "{{ cve_report_file }}" ]; then
          echo "CRITICAL=0"
          echo "HIGH=0"
          echo "MEDIUM=0"
          echo "LOW=0"
          exit 0
        fi

        # Count vulnerabilities by severity (with default 0 if null)
        CRITICAL=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length // 0' {{ cve_report_file }} 2>/dev/null || echo 0)
        HIGH=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH")] | length // 0' {{ cve_report_file }} 2>/dev/null || echo 0)
        MEDIUM=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="MEDIUM")] | length // 0' {{ cve_report_file }} 2>/dev/null || echo 0)
        LOW=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="LOW")] | length // 0' {{ cve_report_file }} 2>/dev/null || echo 0)

        # Ensure we have numeric values
        CRITICAL=${CRITICAL:-0}
        HIGH=${HIGH:-0}
        MEDIUM=${MEDIUM:-0}
        LOW=${LOW:-0}

        # Generate summary report
        cat > {{ cve_summary_file }} << EOF
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        CVE VULNERABILITY SCAN REPORT
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        ðŸ“… Date: $(date '+%Y-%m-%d %H:%M:%S')
        ðŸ–¥ï¸  Host: {{ ansible_hostname }}
        ðŸŒ IP: {{ ansible_default_ipv4.address | default('N/A') }}
        ðŸ§ OS: {{ ansible_distribution }} {{ ansible_distribution_version }}

        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        VULNERABILITY SUMMARY
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        ðŸ”´ CRITICAL: $CRITICAL
        ðŸŸ  HIGH:     $HIGH
        ðŸŸ¡ MEDIUM:   $MEDIUM
        ðŸŸ¢ LOW:      $LOW

        ðŸ“Š TOTAL:    $(($CRITICAL + $HIGH + $MEDIUM + $LOW))

        EOF

        # Add critical vulnerabilities details if any
        if [ "$CRITICAL" -gt 0 ] 2>/dev/null; then
          echo "" >> {{ cve_summary_file }}
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€" >> {{ cve_summary_file }}
          echo " ðŸ”´ CRITICAL VULNERABILITIES (TOP 10)" >> {{ cve_summary_file }}
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€" >> {{ cve_summary_file }}
          echo "" >> {{ cve_summary_file }}

          jq -r '.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL") |
            "CVE ID:     " + .VulnerabilityID + "\n" +
            "Package:    " + .PkgName + " " + .InstalledVersion + "\n" +
            "Fixed:      " + (.FixedVersion // "No fix available") + "\n" +
            "Title:      " + (.Title // "N/A") + "\n" +
            "---"' {{ cve_report_file }} 2>/dev/null | head -50 >> {{ cve_summary_file }}
        fi

        # Add high vulnerabilities summary
        if [ "$HIGH" -gt 0 ] 2>/dev/null; then
          echo "" >> {{ cve_summary_file }}
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€" >> {{ cve_summary_file }}
          echo " ðŸŸ  HIGH VULNERABILITIES (TOP 10)" >> {{ cve_summary_file }}
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€" >> {{ cve_summary_file }}
          echo "" >> {{ cve_summary_file }}

          jq -r '.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH") |
            "CVE ID:     " + .VulnerabilityID + "\n" +
            "Package:    " + .PkgName + " " + .InstalledVersion + "\n" +
            "Fixed:      " + (.FixedVersion // "No fix available") + "\n" +
            "---"' {{ cve_report_file }} 2>/dev/null | head -40 >> {{ cve_summary_file }}
        fi

        echo "" >> {{ cve_summary_file }}
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" >> {{ cve_summary_file }}
        echo "ðŸ“‹ Full JSON report: {{ cve_report_file }}" >> {{ cve_summary_file }}
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" >> {{ cve_summary_file }}

        # Output counts for Ansible (always at the end)
        echo "CRITICAL=$CRITICAL"
        echo "HIGH=$HIGH"
        echo "MEDIUM=$MEDIUM"
        echo "LOW=$LOW"
      args:
        executable: /bin/bash
      register: cve_summary
      changed_when: false

    - name: Extract CVE counts
      set_fact:
        cve_critical: "{{ (cve_summary.stdout_lines | select('match', '^CRITICAL=') | list | first | default('CRITICAL=0')).split('=')[1] }}"
        cve_high: "{{ (cve_summary.stdout_lines | select('match', '^HIGH=') | list | first | default('HIGH=0')).split('=')[1] }}"
        cve_medium: "{{ (cve_summary.stdout_lines | select('match', '^MEDIUM=') | list | first | default('MEDIUM=0')).split('=')[1] }}"
        cve_low: "{{ (cve_summary.stdout_lines | select('match', '^LOW=') | list | first | default('LOW=0')).split('=')[1] }}"

    - name: Display CVE summary
      debug:
        msg: |
          ðŸ” CVE Scan completed for {{ ansible_hostname }}

          ðŸ”´ CRITICAL: {{ cve_critical }}
          ðŸŸ  HIGH:     {{ cve_high }}
          ðŸŸ¡ MEDIUM:   {{ cve_medium }}
          ðŸŸ¢ LOW:      {{ cve_low }}

          ðŸ“‹ Full report: {{ cve_summary_file }}

    - name: Check if CVE reports exist
      stat:
        path: "{{ item }}"
      register: cve_files
      loop:
        - "{{ cve_report_file }}"
        - "{{ cve_summary_file }}"

    - name: Fetch CVE JSON report to Ansible server
      fetch:
        src: "{{ cve_report_file }}"
        dest: "{{ log_dir | default('/home/ansible/log/ansible-maintenance') }}/cve-reports/{{ ansible_hostname }}-{{ ansible_date_time.date }}.json"
        flat: yes
      when: cve_files.results[0].stat.exists

    - name: Fetch CVE summary report to Ansible server
      fetch:
        src: "{{ cve_summary_file }}"
        dest: "{{ log_dir | default('/home/ansible/log/ansible-maintenance') }}/cve-reports/{{ ansible_hostname }}-{{ ansible_date_time.date }}.txt"
        flat: yes
      when: cve_files.results[1].stat.exists

    - name: Send Gotify notification for CRITICAL vulnerabilities
      uri:
        url: "{{ gotify_url }}/message?token={{ gotify_token }}"
        method: POST
        body_format: json
        body:
          title: "ðŸ”´ CRITICAL CVE Alert - {{ ansible_hostname }}"
          message: |
            {{ cve_critical }} CRITICAL vulnerabilities detected on {{ ansible_hostname }}!

            ðŸ”´ CRITICAL: {{ cve_critical }}
            ðŸŸ  HIGH: {{ cve_high }}
            ðŸŸ¡ MEDIUM: {{ cve_medium }}

            âš ï¸ IMMEDIATE ACTION REQUIRED

            Run security updates:
            ansible-playbook maintenance-security.yml --limit {{ ansible_hostname }}

            Full report: {{ cve_summary_file }}
          priority: 10
        status_code: 200
      when:
        - gotify_url != ''
        - gotify_token != ''
        - cve_critical | int > 0
      delegate_to: localhost
      become: no

    - name: Send Gotify notification for HIGH vulnerabilities
      uri:
        url: "{{ gotify_url }}/message?token={{ gotify_token }}"
        method: POST
        body_format: json
        body:
          title: "ðŸŸ  HIGH CVE Alert - {{ ansible_hostname }}"
          message: |
            {{ cve_high }} HIGH vulnerabilities detected on {{ ansible_hostname }}

            ðŸ”´ CRITICAL: {{ cve_critical }}
            ðŸŸ  HIGH: {{ cve_high }}
            ðŸŸ¡ MEDIUM: {{ cve_medium }}

            Consider running security updates soon.

            Full report: {{ cve_summary_file }}
          priority: 7
        status_code: 200
      when:
        - gotify_url != ''
        - gotify_token != ''
        - cve_high | int > 0
        - cve_critical | int == 0
      delegate_to: localhost
      become: no

    - name: Clean old CVE reports (keep last 30 days)
      find:
        paths: "{{ cve_report_dir }}"
        patterns: "cve-*.json,cve-*.txt"
        age: 30d
      register: old_reports

    - name: Remove old CVE reports
      file:
        path: "{{ item.path }}"
        state: absent
      loop: "{{ old_reports.files }}"
      when: old_reports.files | length > 0